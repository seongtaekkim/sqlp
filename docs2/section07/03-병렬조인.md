# 03. 병렬조인



## 1) EMP, DEPT 테이블을 파티션으로 생성

-  `PX PARTITION` 실행계획이 나오려면 조인키의 파티션 이름이 서로 동일해야 한다.

```sql
-- 오라클 버전
SELECT * FROM v$version
;

BANNER                                                            
------------------------------------------------------------------
Oracle Database 10g Enterprise Edition Release 10.2.0.3.0 - 64bit  
PL/SQL Release 10.2.0.3.0 - Production                            

-- EMP, DEPT 파티션 테이블 생성
DROP TABLE USER.EMP;
DROP TABLE USER.DEPT;

CREATE TABLE EMP
       (EMPNO NUMBER(4) NOT NULL,
        ENAME VARCHAR2(10),
        JOB VARCHAR2(9),
        MGR NUMBER(4),
        HIREDATE DATE,
        SAL NUMBER(7, 2),
        COMM NUMBER(7, 2),
        DEPTNO NUMBER(2))     
PARTITION BY HASH (DEPTNO)
(
    PARTITION PH_DEPTNO_001,
    PARTITION PH_DEPTNO_002,
    PARTITION PH_DEPTNO_003,
    PARTITION PH_DEPTNO_004
);  


INSERT INTO EMP VALUES
        (7369, 'SMITH',  'CLERK',     7902,
        TO_DATE('17-DEC-1980', 'DD-MON-YYYY'),  800, NULL, 20);
INSERT INTO EMP VALUES
        (7499, 'ALLEN',  'SALESMAN',  7698,
        TO_DATE('20-FEB-1981', 'DD-MON-YYYY'), 1600,  300, 30);
INSERT INTO EMP VALUES
        (7521, 'WARD',   'SALESMAN',  7698,
        TO_DATE('22-FEB-1981', 'DD-MON-YYYY'), 1250,  500, 30);
INSERT INTO EMP VALUES
        (7566, 'JONES',  'MANAGER',   7839,
        TO_DATE('2-APR-1981', 'DD-MON-YYYY'),  2975, NULL, 20);
INSERT INTO EMP VALUES
        (7654, 'MARTIN', 'SALESMAN',  7698,
        TO_DATE('28-SEP-1981', 'DD-MON-YYYY'), 1250, 1400, 30);
INSERT INTO EMP VALUES
        (7698, 'BLAKE',  'MANAGER',   7839,
        TO_DATE('1-MAY-1981', 'DD-MON-YYYY'),  2850, NULL, 30);
INSERT INTO EMP VALUES
        (7782, 'CLARK',  'MANAGER',   7839,
        TO_DATE('9-JUN-1981', 'DD-MON-YYYY'),  2450, NULL, 10);
INSERT INTO EMP VALUES
        (7788, 'SCOTT',  'ANALYST',   7566,
        TO_DATE('09-DEC-1982', 'DD-MON-YYYY'), 3000, NULL, 20);
INSERT INTO EMP VALUES
        (7839, 'KING',   'PRESIDENT', NULL,
        TO_DATE('17-NOV-1981', 'DD-MON-YYYY'), 5000, NULL, 10);
INSERT INTO EMP VALUES
        (7844, 'TURNER', 'SALESMAN',  7698,
        TO_DATE('8-SEP-1981', 'DD-MON-YYYY'),  1500,    0, 30);
INSERT INTO EMP VALUES
        (7876, 'ADAMS',  'CLERK',     7788,
        TO_DATE('12-JAN-1983', 'DD-MON-YYYY'), 1100, NULL, 20);
INSERT INTO EMP VALUES
        (7900, 'JAMES',  'CLERK',     7698,
        TO_DATE('3-DEC-1981', 'DD-MON-YYYY'),   950, NULL, 30);
INSERT INTO EMP VALUES
        (7902, 'FORD',   'ANALYST',   7566,
        TO_DATE('3-DEC-1981', 'DD-MON-YYYY'),  3000, NULL, 20);
INSERT INTO EMP VALUES
        (7934, 'MILLER', 'CLERK',     7782,
        TO_DATE('23-JAN-1982', 'DD-MON-YYYY'), 1300, NULL, 10);

CREATE TABLE DEPT
       (DEPTNO NUMBER(2),
        DNAME VARCHAR2(14),
        LOC VARCHAR2(13) )
PARTITION BY HASH (DEPTNO)
(
    PARTITION PH_DEPTNO_001,
    PARTITION PH_DEPTNO_002,
    PARTITION PH_DEPTNO_003,
    PARTITION PH_DEPTNO_004
);  
      
INSERT INTO DEPT VALUES (10, 'ACCOUNTING', 'NEW YORK');
INSERT INTO DEPT VALUES (20, 'RESEARCH',   'DALLAS');
INSERT INTO DEPT VALUES (30, 'SALES',      'CHICAGO');
INSERT INTO DEPT VALUES (40, 'OPERATIONS', 'BOSTON');

COMMIT;
/

BEGIN
  DBMS_STATS.GATHER_TABLE_STATS(USER,
                                'EMP',
                                CASCADE => TRUE);
END;
/

BEGIN
  DBMS_STATS.GATHER_TABLE_STATS(USER,
                                'DEPT',
                                CASCADE => TRUE);
END;
/

-- XPLAN 확인
EXPLAIN PLAN FOR
SELECT /*+ LEADING(E D) FULL(D) FULL(E) PARALLEL(D 2) PARALLEL(E 2) PQ_DISTRIBUTE(D, NONE, NONE) */
       D.DEPTNO,
       D.DNAME,
       E.ENAME
FROM   DEPT D,
       EMP  E
WHERE  E.DEPTNO = D.DEPTNO  
;

@xplan
---------------------------------------------------------------------------------------------------------------------------------
| Id  | Operation               | Name     | Rows  | Bytes | Cost (%CPU)| Time     | Pstart| Pstop |    TQ  |IN-OUT| PQ Distrib |
---------------------------------------------------------------------------------------------------------------------------------
|   0 | SELECT STATEMENT        |          |    14 |   308 |    14   (8)| 00:00:01 |       |       |        |      |            |
|   1 |  PX COORDINATOR         |          |       |       |            |          |       |       |        |      |            |
|   2 |   PX SEND QC (RANDOM)   | :TQ10000 |    14 |   308 |    14   (8)| 00:00:01 |       |       |  Q1,00 | P->S | QC (RAND)  |
|   3 |    PX PARTITION HASH ALL|          |    14 |   308 |    14   (8)| 00:00:01 |     1 |     4 |  Q1,00 | PCWC |            |
|*  4 |     HASH JOIN           |          |    14 |   308 |    14   (8)| 00:00:01 |       |       |  Q1,00 | PCWP |            |
|   5 |      TABLE ACCESS FULL  | EMP      |    14 |   126 |     7   (0)| 00:00:01 |     1 |     4 |  Q1,00 | PCWP |            |
|   6 |      TABLE ACCESS FULL  | DEPT     |     4 |    52 |     7   (0)| 00:00:01 |     1 |     4 |  Q1,00 | PCWP |            |
---------------------------------------------------------------------------------------------------------------------------------
                                                                                                                                 
Predicate Information (identified by operation id):                                                                              
---------------------------------------------------                                                                              
                                                                                                                                 
   4 - access("E"."DEPTNO"="D"."DEPTNO")                                                                                         

18 rows selected.
```

![스크린샷 2024-05-30 오전 10.17.55](../../img/207.png)

- `Full Partition Wise` 방법은 조인키가 같은 기준으로 파티셔닝(equi-partitioning) 되어 있으면 가능(대신 Partition 이름이 같아야 함!!!)
- 내부 프로세스는, P000과 P001 서버 프로세스가 각각 Partition Pair1과 Partition Pair2를 처리하는데 이 때 각각 Partition-Pair가 형성되어 있으므로 각 서버 프로세스가 하나씩 독립적으로 조인을 수행할 수 있다.
- P000, P001 서버 프로세스 옆에 표시된 숫자 9와 5는 각각 조인을 수행하고 나서 QC에ㅔㄱ 전송한 조인 결과 숫자이며, 만약 Partition-Pair가 10개면, 두 개 서버 프로세스가 각각 5개씩 순차적으로 처리함.
- `Full Partition Wise` 특징
  1) 다른 병렬 조인은 두 개의 서버집합이 필요한 반면, `Full Partition Wise`는 하나의 서버집합만 필요
  2) `Full Partition Wise` 조인은 파티션 기반 Granule이므로 서버 프로세스 개수는 파티션 개수 이하로 제한
  3) 파티션 방식은 어떤 것이든 상관없음.
  4) 조인 방식도 어떤 것이든 선택 가능함.













































































